# data only container pattern
datatest:
  image: muccg/debian8-base
  volumes:
    - .:/app
    - data/tests:/data

dbtest:
  image: postgres:9.4
  environment:
    - POSTGRES_USER=rdrfapp
    - POSTGRES_PASSWORD=rdrfapp
  ports:
    - ":5432"

cachetest:
  image: memcached:1.4

mongotest:
  image: mongo:3.0
  command: mongod --smallfiles

webtest:
  build: .
  command: runserver
  environment:
    - DJANGO_SETTINGS_MODULE=rdrf.settings
    - DBUSER=rdrfapp
    - WAIT_FOR_DB=1
    - WAIT_FOR_CACHE=1
    - WAIT_FOR_MONGO=1
  volumes_from:
    - datatest      
  ports:
    - ":8000"
  links:
    - dbtest:db
    - cachetest:cache
    - mongotest:mongo

reportingtest:
  image: muccg/postgres-ssl:9.4
  environment:
    - POSTGRES_USER=reporting
    - POSTGRES_PASSWORD=reporting
  ports:
    - "15634:5432"


# runs the tests against the stack above
testhost:
  image: rdrf_webtest
  command: runtests
  environment:
    - DJANGO_SETTINGS_MODULE=rdrf.settings
    - DBUSER=rdrfapp
    - WAIT_FOR_DB=1
    - WAIT_FOR_WEB=1
    - WAIT_FOR_MONGO=1
  volumes_from:
    - datatest      
  links:
    - dbtest:db
    - webtest:web
    - mongotest:mongo
    - reportingtest:reporting
